<app-header></app-header>

<div class="dashboard-container">
  <!-- ‚úÖ Sidebar -->
  <aside class="sidebar">
    <ul>
      <li (click)="goManageGames()"><i class="fa-solid fa-gamepad"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏°</li>
      <li class="active" (click)="goDiscount()"><i class="fa-solid fa-percent"></i> ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</li>
      <li (click)="goRanking()"><i class="fa-solid fa-list-ol"></i> ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</li>
      <li (click)="goTransactions()"><i class="fa-solid fa-clipboard-list"></i> ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</li>
    </ul>
  </aside>

  <!-- ‚úÖ Main Content -->
  <main class="manage-content">
    <h2><i class="fa-solid fa-tags"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</h2>

    <div class="top-bar">
      <button class="add-btn" (click)="openCreate()">
        <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà
      </button>
      <p class="message">{{ message }}</p>
    </div>

    <div *ngIf="loading" class="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

    <!-- ‚úÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î -->
    <div class="table-wrapper" *ngIf="!loading && discounts.length > 0">
      <table class="discount-table">
        <thead>
          <tr>
            <th>‡πÇ‡∏Ñ‡πâ‡∏î</th>
            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
            <th>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</th>
            <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th>
            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ä‡πâ/‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
            <th>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let d of discounts">
            <td>{{ d.code }}</td>
            <td>{{ d.type === 'percent' ? '‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå' : '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' }}</td>
            <td>
              {{ d.type === 'percent'
                ? d.value + '%'
                : (d.value | currency:'THB':'symbol':'1.0-0') }}
            </td>
            <td>{{ (d.minSpend || 0) | currency:'THB':'symbol':'1.0-0' }}</td>
            <td>{{ d.usedCount || 0 }}/{{ d.usageLimit || 1 }}</td>
            <td>{{ d.expireAt ? (d.expireAt | date:'dd/MM/yyyy') : '-' }}</td>
            <td>
              <span
                class="status"
                [ngClass]="{
                  active: d.isActive && (d.usedCount || 0) < (d.usageLimit || 1),
                  inactive: !d.isActive,
                  full: (d.usedCount || 0) >= (d.usageLimit || 1)
                }"
              >
                {{ d.status || (d.isActive
                  ? ((d.usedCount || 0) >= (d.usageLimit || 1)
                    ? '‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß'
                    : '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ')
                  : '‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô') }}
              </span>
            </td>

            <td class="action-buttons">
              <button class="edit-btn" (click)="openEdit(d)">
                <i class="fa-solid fa-pen-to-square"></i>
              </button>

              <button class="toggle-btn" (click)="toggleActive(d)">
                <i
                  class="fa-solid"
                  [class.fa-toggle-on]="d.isActive"
                  [class.fa-toggle-off]="!d.isActive"
                ></i>
              </button>

              <button class="delete-btn" (click)="delete(d)">
                <i class="fa-solid fa-trash"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div *ngIf="!loading && discounts.length === 0" class="empty">
      ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
    </div>

    <!-- ‚úÖ ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
    <div class="form-panel" *ngIf="panelMode">
      <div class="panel-content">
        <button type="button" class="close-btn" (click)="cancelPanel()">√ó</button>
        <h3>
          {{ panelMode === 'create' ? '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà' : '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î' }}
        </h3>

        <form (ngSubmit)="submit()">
          <div class="form-group">
            <label>‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
            <input
              type="text"
              [(ngModel)]="form.code"
              name="code"
              required
              [readonly]="panelMode === 'edit'"
            />
          </div>

          <div class="form-group">
            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
            <select [(ngModel)]="form.type" name="type">
              <option value="percent">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</option>
              <option value="fixed">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option>
            </select>
          </div>

          <div class="form-group">
            <label>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏•‡∏î</label>
            <input type="number" [(ngModel)]="form.value" name="value" required />
          </div>

          <div class="form-group">
            <label>‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ö‡∏≤‡∏ó)</label>
            <input type="number" [(ngModel)]="form.minSpend" name="minSpend" />
          </div>

          <div class="form-group" *ngIf="form.type === 'percent'">
            <label>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ö‡∏≤‡∏ó)</label>
            <input
              type="number"
              [(ngModel)]="form.maxDiscount"
              name="maxDiscount"
            />
          </div>

          <div class="form-group">
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏£‡∏ß‡∏° (‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ)</label>
            <input
              type="number"
              [(ngModel)]="form.usageLimit"
              name="usageLimit"
              min="1"
            />
          </div>

          <div class="form-group">
            <label>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label>
            <input type="date" [(ngModel)]="form.expireAt" name="expireAt" />
          </div>

          <div class="form-group switch-group">
            <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
            <label class="switch">
              <input type="checkbox" [(ngModel)]="form.isActive" name="isActive" />
              <span class="slider"></span>
            </label>
          </div>

          <div class="form-actions">
            <button type="submit" class="save-btn" [disabled]="loading">
              üíæ {{ loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : (panelMode === 'create' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î' : '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï') }}
            </button>
            <button type="button" class="cancel-btn" (click)="cancelPanel()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </form>
      </div>
    </div>
  </main>
</div>
